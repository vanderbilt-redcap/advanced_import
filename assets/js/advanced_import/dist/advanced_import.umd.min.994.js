"use strict";(("undefined"!==typeof self?self:this)["webpackChunkadvanced_import"]=("undefined"!==typeof self?self:this)["webpackChunkadvanced_import"]||[]).push([[994],{6491:function(e,t,s){s.d(t,{Z:function(){return _}});var o=function(){var e=this,t=e._self._c;return t("div",[e.processing?t("div",[t("b-progress",{attrs:{max:e.max,"show-progress":"",animated:!1,variant:"primary",size:"sm"}},[t("b-progress-bar",{attrs:{value:e.progress,label:`${(100*e.progress).toFixed(2)}%`}})],1),t("div",{staticClass:"text-muted small"},[e.uploaded_bytes&&e.uploaded_bytes>0?t("span",[e._v("uploaded "+e._s(e.formatBytes(e.uploaded_bytes))+" of "+e._s(e.formatBytes(e.file_size)))]):e._e(),t("non-blank-space")],1)],1):e._e(),e._e()])},r=[],i=s(7614),a=s(1982);const n=1024e3,l=512e4,c=20;class d{constructor({file_size:e,name:t,percentage:s,progress:o,unique_name:r,uploaded_bytes:i,written_bytes:a}){this.file_size=e,this.name=t,this.percentage=s,this.progress=o,this.unique_name=r,this.uploaded_bytes=i,this.written_bytes=a}}var p={data(){return{cancel:null,content:"",start:0,end:0,max:1,processing:!1,paused:!1,abort:!1,remote_file_name:null,progress:0,uploaded_bytes:0,file_size:0,formatBytes:a.td}},props:{files:{type:[File,Array],default:()=>[]}},computed:{file(){let e,t=this.files;return"object"===typeof t?e=t:Array.isArray(t)&&t.length>0&&(e=t[0]),e?new File([e],e.name):null},chunk_size(){return this.calcChunkSize(this.file)},processed(){let e=this.uploaded_bytes||0,t=this.file_size||0,s=(0,a.td)(e),o=(0,a.td)(t);return`${s}/${o}`}},destroyed(){this.stop()},methods:{async processChunk(e,t){try{if(this.abort)return;const s=await this.sendChunk(e,t),{data:o}=s;if(!o)throw new Error("no response");const r=new d(o);return this.updateMetadata(r),this.$emit("progress",{file:e,metadata:r}),this.start=this.end,!this.paused&&this.end<e.size?this.upload():(this.reset(),this.$emit("completed",r),r)}catch(s){const{response:t={}}=s,{data:o={}}=t,{message:r=""}=o;this.$emit("error",{message:r,file:e,error:s}),this.reset()}},calculateProgress(e,t){try{const s=t/e.size;return t<0?0:t>e.size?1:s}catch(s){return 0}},sendChunk(e,t){const s=this.$API.dispatch("upload/upload",e,t);return this.cancel=s.cancel,s},calcChunkSize(e){if(!e)return n;const{size:t=0}=e;let s=t/c;return s<n?n:s>l?l:s},updateMetadata({file_size:e,progress:t,unique_name:s,uploaded_bytes:o}){return this.file.unique_name=s,this.remote_file_name=s,this.uploaded_bytes=o,this.file_size=e,this.progress=t,t},async upload(){if(!this.file)return;const e=this.file;this.processing=!0,this.paused=!1,this.end=this.start+this.chunk_size+1;const t=e.slice(this.start,this.end),s=new i.Z,o=await s.readAsDataURLAsync(t);return this.processChunk(e,o)},stop(){"function"===typeof this.cancel&&this.cancel(),this.abort=!0},onPause(){this.processing=!1,this.paused=!0},reset(){setTimeout((()=>{this.cancel=null,this.start=0,this.end=0,this.processing=!1,this.paused=!1,this.abort=!1}),1e3)}}},h=p,u=s(3736),m=(0,u.Z)(h,o,r,!1,null,null,null),_=m.exports},5851:function(e,t,s){s.d(t,{Z:function(){return d}});var o=function(){var e=this,t=e._self._c;return t("div",{staticClass:"overflow-auto"},[t("div",{staticClass:"d-flex flex-row justify-content-start align-items-start"},[t("b-button",{attrs:{size:"sm",variant:"info",disabled:e.loading},on:{click:e.getLogs}},[e.loading?t("font-awesome-icon",{attrs:{icon:"spinner",spin:""}}):t("font-awesome-icon",{attrs:{icon:"sync"}}),t("span",[e._v(" Reload")])],1),e.hasItems?t("b-button",{directives:[{name:"b-modal",rawName:"v-b-modal.modal-delete",modifiers:{"modal-delete":!0}}],staticClass:"ml-2",attrs:{size:"sm",variant:"danger",disabled:e.loading}},[t("font-awesome-icon",{attrs:{icon:"trash"}}),t("span",[e._v(" Delete logs")])],1):e._e(),t("b-modal",{attrs:{id:"modal-delete",title:"Delete logs"},on:{ok:e.handleOkDelete}},[t("p",{staticClass:"my-4"},[e._v("Are you sure you want to delete all logs for the current project?")])]),e.hasItems?t("b-pagination",{staticClass:"ml-2",attrs:{"total-rows":e.rows,"per-page":e.per_page,"aria-controls":"my-table",size:"sm"},model:{value:e.current_page,callback:function(t){e.current_page=t},expression:"current_page"}}):e._e()],1),t("b-table",{staticClass:"my-2",attrs:{id:"my-table",items:e.items_proxy,"_per-page":"per_page","_current-page":"current_page",small:"",bordered:"",striped:"",hover:""}}),e.hasItems?t("b-pagination",{attrs:{"total-rows":e.rows,"per-page":e.per_page,"aria-controls":"my-table",size:"sm"},model:{value:e.current_page,callback:function(t){e.current_page=t},expression:"current_page"}}):e._e()],1)},r=[],i=(s(7658),s(629)),a={data(){return{per_page:20,current_page:1,loading:!1}},async created(){},computed:{...(0,i.rn)({items:e=>e.logs.list}),items_proxy(){const e=[...this.items];let t=this.per_page,s=this.current_page*t-e.length;s<0&&(s=0);const o="";let r={"no logs":o};if(e.length>0){r={};let t=e[0];for(let e of Object.keys(t))r[e]=o}for(let i=0;i<s;i++)e.push(r);return e},rows(){const e=this.$store.getters["logs/total"];return e||this.items.length},hasItems(){try{return this.items.length>0}catch(e){return!1}}},watch:{current_page:{immediate:!0,handler(){this.getLogs()}}},methods:{async getLogs(){try{this.loading=!0;const e=this.per_page,t=this.per_page*(this.current_page-1),s=await this.$API.dispatch("logs/get",{start:t,limit:e}),{data:o={}}=s,{data:r={},metadata:i={}}=o;await this.$store.dispatch("logs/setState",{list:r,metadata:i})}catch(e){console.log(e)}finally{this.loading=!1}},async handleOkDelete(){const e=await this.$API.dispatch("logs/delete");console.log(e),this.getLogs()}}},n=a,l=s(3736),c=(0,l.Z)(n,o,r,!1,null,"d102da56",null),d=c.exports},3994:function(e,t,s){s.r(t),s.d(t,{default:function(){return b}});var o=function(){var e=this,t=e._self._c;return t("div",[t("h6",[e._v("Review your settings")]),t("table",{staticClass:"table table-bordered table-striped"},[e._m(0),t("tbody",e._l(e.settings,(function(s,o){return t("tr",{key:o},[t("td",[e._v(e._s(o))]),t("td",[t("pre",[e._v(e._s(s))])])])})),0)]),t("div",{staticClass:"buttons d-flex flex-row justify-content-between"},[e._t("left"),t("section",[t("button",{staticClass:"btn btn-primary ml-2",attrs:{disabled:e.processing},on:{click:e.importCSV}},[e.processing?t("font-awesome-icon",{attrs:{icon:"spinner",spin:"","fixed-width":""}}):t("font-awesome-icon",{attrs:{icon:"file-import","fixed-width":""}}),t("span",[e._v(" import")])],1)]),e._t("right",null,{validation:e.$v})],2),t("b-modal",{ref:"modal-success",attrs:{title:"Process completed","ok-only":"",size:"xl"},on:{hidden:e.onCloseModal}},[t("p",{staticClass:"my-4"},[e._v("The import proces is completed. Please check the "),t("router-link",{attrs:{to:{name:"logs"}}},[e._v("logs")]),e._v(" for details.")],1),t("LogsTable",{ref:"logs"})],1),t("b-modal",{ref:"modal-upload",attrs:{title:"Uploading CSV file","ok-only":"","no-close-on-esc":"","no-close-on-backdrop":"","hide-header-close":"","ok-title":"cancel"},on:{ok:e.onProcessStopped}},[t("FileUploader",{ref:"uploader",attrs:{files:e.files}})],1),t("b-modal",{ref:"modal-process",attrs:{id:"modal-process",title:"Processing CSV file","ok-only":"","no-close-on-esc":"","no-close-on-backdrop":"","hide-header-close":"","ok-title":"cancel",size:"xl"},on:{ok:e.onProcessStopped}},[t("FileProcesser",{ref:"processer",attrs:{background_process:e.background_process}}),t("LogsTable",{ref:"logs"})],1),t("b-modal",{ref:"modal-abort",attrs:{id:"modal-abort",title:"Process stopped","ok-only":""},on:{ok:e.onProcessStopped}},[t("p",{staticClass:"my-4"},[e._v("The process has been stopped by the user")])])],1)},r=[function(){var e=this,t=e._self._c;return t("thead",[t("tr",[t("th",[e._v("key")]),t("th",[e._v("value")])])])}],i=(s(7658),s(629)),a=s(6491),n=function(){var e=this,t=e._self._c;return t("div",[e.processing&&!e.background_process?t("div",[t("b-progress",{attrs:{max:e.max,"show-progress":"",animated:"",variant:"success",height:"2rem"}},[t("b-progress-bar",{attrs:{value:e.progress,label:`${(100*e.progress).toFixed(2)}%`}})],1),t("div",{staticClass:"text-muted small my-2"},[e.total_lines&&e.total_lines>0?t("span",[e._v("Processed "+e._s(e.current_line)+"/"+e._s(e.total_lines))]):e._e(),t("non-blank-space")],1)],1):e._e(),e._e()])},l=[],c={data(){return{cancel:null,max:1,current_line:0,processing:!1,abort:!1,progress:0}},computed:{...(0,i.rn)({settings:e=>e.import_settings,total_lines:e=>e.csv_data.total_lines})},props:{background_process:{type:Boolean,default:!1}},destroyed(){this.reset()},methods:{async process(e,t=1){if(!this.abort){this.processing=!0;try{const s=async t=>{const o={...this.settings};o.background_process=this.background_process,o.data_row_start=t;const r=this.$API.dispatch("importData/processCSV",e,o);this.cancel=r.cancel;const i=await r,{data:a}=i;if(a){if(this.background_process)return!0;const{line:e=1}=a;let t=this.updateProgress({line:e});return this.$emit("progress",{progress:t}),s(e)}};await s(t),this.$emit("completed")}catch(s){this.$emit("error",s)}finally{this.processing=!1}}},updateProgress({line:e}){if(this.total_lines<=0)return;if(e&&(this.current_line=e),isNaN(this.current_line)||isNaN(this.total_lines))return;this.current_line>this.total_lines&&(this.current_line=this.total_lines);let t=this.current_line/this.total_lines;return this.progress=t,t},reset(){"function"===typeof this.cancel&&this.cancel(),this.abort=!0}}},d=c,p=s(3736),h=(0,p.Z)(d,n,l,!1,null,null,null),u=h.exports,m=s(5851),_={components:{FileUploader:a.Z,FileProcesser:u,LogsTable:m.Z},data(){return{processing:!1,background_process:!1}},computed:{...(0,i.rn)({files:e=>e.import_settings.files,event_id:e=>e.import_settings.event_id,form_name:e=>e.import_settings.form_name,import_settings:e=>e.import_settings}),dynamic_fields(){return this.$store.getters["import_settings/mappedDynamicFields"]},mappedFieldsWithCsvNames(){return this.$store.getters["import_settings/mappedFieldsWithCsvNames"]},settings(){const{name:e=""}=this.files||{},t={...this.import_settings},s={"file name":e,"event ID":t.event_id,"form name":t.form_name,"field delimiter":t.field_delimiter,"text qualifier":t.text_qualifier,"dates format":t.dates_format,"import mode":t.import_mode,"primary key":t.primary_key,"dynamic fields":this.dynamic_fields,mapping:this.mappedFieldsWithCsvNames};return s}},methods:{showModal(e){const t=new Promise(((t,s)=>{const o=this.$refs[e];if(!o)return s();const r=()=>{o.$off("shown",r),t()};o.$on("shown",r),o.show()}));return t},closeModal(e){const t=new Promise(((t,s)=>{const o=this.$refs[e];if(!o)return s();const r=()=>{o.$off("hidden",r),t()};o.$on("hidden",r),o.hide()}));return t},async upload(){await this.showModal("modal-upload");const e=this.$refs.uploader;return e.$on("completed",(()=>{this.closeModal("modal-upload")})),e.$on("error",(({message:e,file:t,error:s})=>{console.log({message:e,file:t,error:s})})),e.upload()},updateLogs(){const{getLogs:e}=this.$refs.logs;"function"===typeof e&&e()},async showCompleted(){await this.showModal("modal-success")},async enqueProcess(e){try{const t={...this.import_settings};t.dynamic_fields=this.dynamic_fields;const s=await this.$API.dispatch("importData/enqueue",e,t),{data:o}=s,r=`Import process created (ID ${o["job_id"]}). Please check your logs.`;await this.$bvModal.msgBoxOk(r,{title:"Success",buttonSize:"sm"}),this.$router.push({name:"home"})}catch(t){let e=t;if("object"===typeof t){const{response:{data:s}}=t,{message:o="error"}=s;e=`${o}`}this.$bvModal.msgBoxOk(e,{title:"Error",buttonSize:"sm"})}},async onProcessStopped(){await this.showModal("modal-abort")},async importCSV(){try{const{unique_name:e}=await this.upload();if(!e)return;await this.enqueProcess(e)}catch(e){console.log(e)}finally{this.processing=!1,this.background_process=!1}},onCloseModal(){console.log("done")}},validations(){return{}}},g=_,f=(0,p.Z)(g,o,r,!1,null,"fcebd24e",null),b=f.exports}}]);
//# sourceMappingURL=advanced_import.umd.min.994.js.map