"use strict";(("undefined"!==typeof self?self:this)["webpackChunkadvanced_import"]=("undefined"!==typeof self?self:this)["webpackChunkadvanced_import"]||[]).push([[886],{8336:function(e,t,r){r.d(t,{Z:function(){return v}});var n=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",[e.processing?r("div",[r("b-progress",{attrs:{max:e.max,"show-progress":"",animated:!1,variant:"primary",size:"sm"}},[r("b-progress-bar",{attrs:{value:e.progress,label:(100*e.progress).toFixed(2)+"%"}})],1),r("div",{staticClass:"text-muted small"},[e.uploaded_bytes&&e.uploaded_bytes>0?r("span",[e._v("uploaded "+e._s(e.formatBytes(e.uploaded_bytes))+" of "+e._s(e.formatBytes(e.file_size)))]):e._e(),r("non-blank-space")],1)],1):e._e(),e._e()])},s=[],a=r(2697),o=r(7742),i=r(4596),c=(r(5666),r(8309),r(2222),r(7042),r(5822)),u=r(8796),l=1024e3,p=512e4,d=20,m=function e(t){var r=t.file_size,n=t.name,s=t.percentage,a=t.progress,o=t.unique_name,c=t.uploaded_bytes,u=t.written_bytes;(0,i.Z)(this,e),this.file_size=r,this.name=n,this.percentage=s,this.progress=a,this.unique_name=o,this.uploaded_bytes=c,this.written_bytes=u},f={data:function(){return{cancel:null,content:"",start:0,end:0,max:1,processing:!1,paused:!1,abort:!1,remote_file_name:null,progress:0,uploaded_bytes:0,file_size:0,formatBytes:u.td}},props:{files:{type:[File,Array],default:function(){return[]}}},computed:{file:function(){var e,t=this.files;return"object"===(0,o.Z)(t)?e=t:Array.isArray(t)&&t.length>0&&(e=t[0]),e?new File([e],e.name):null},chunk_size:function(){return this.calcChunkSize(this.file)},processed:function(){var e=this.uploaded_bytes||0,t=this.file_size||0,r=(0,u.td)(e),n=(0,u.td)(t);return"".concat(r,"/").concat(n)}},destroyed:function(){this.stop()},methods:{processChunk:function(e,t){var r=this;return(0,a.Z)(regeneratorRuntime.mark((function n(){var s,a,o,i,c,u,l,p,d;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(n.prev=0,!r.abort){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,r.sendChunk(e,t);case 5:if(s=n.sent,a=s.data,console.log(a),a){n.next=10;break}throw new Error("no response");case 10:if(o=new m(a),r.updateMetadata(o),r.$emit("progress",{file:e,metadata:o}),r.start=r.end,r.paused||!(r.end<e.size)){n.next=18;break}return n.abrupt("return",r.upload());case 18:return r.reset(),r.$emit("completed",o),n.abrupt("return",o);case 21:n.next=30;break;case 23:n.prev=23,n.t0=n["catch"](0),i=n.t0.response,c=void 0===i?{}:i,u=c.data,l=void 0===u?{}:u,p=l.message,d=void 0===p?"":p,r.$emit("error",{message:d,file:e,error:n.t0}),r.reset();case 30:case"end":return n.stop()}}),n,null,[[0,23]])})))()},calculateProgress:function(e,t){try{var r=t/e.size;return t<0?0:t>e.size?1:r}catch(n){return 0}},sendChunk:function(e,t){var r=this.$API.dispatch("upload/upload",e,t);return this.cancel=r.cancel,r},calcChunkSize:function(e){if(!e)return l;var t=e.size,r=void 0===t?0:t,n=r/d;return n<l?l:n>p?p:n},updateMetadata:function(e){var t=e.file_size,r=e.progress,n=e.unique_name,s=e.uploaded_bytes;return this.file.unique_name=n,this.remote_file_name=n,this.uploaded_bytes=s,this.file_size=t,this.progress=r,r},upload:function(){var e=this;return(0,a.Z)(regeneratorRuntime.mark((function t(){var r,n,s,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.file){t.next=2;break}return t.abrupt("return");case 2:return r=e.file,e.processing=!0,e.paused=!1,e.end=e.start+e.chunk_size+1,n=r.slice(e.start,e.end),s=new c.Z,t.next=10,s.readAsDataURLAsync(n);case 10:return a=t.sent,t.abrupt("return",e.processChunk(r,a));case 12:case"end":return t.stop()}}),t)})))()},stop:function(){"function"===typeof this.cancel&&this.cancel(),this.abort=!0},onPause:function(){this.processing=!1,this.paused=!0},reset:function(){var e=this;setTimeout((function(){e.cancel=null,e.start=0,e.end=0,e.processing=!1,e.paused=!1,e.abort=!1}),1e3)}}},h=f,g=r(3736),_=(0,g.Z)(h,n,s,!1,null,null,null),v=_.exports},6775:function(e,t,r){r.d(t,{Z:function(){return m}});var n=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"overflow-auto"},[r("div",{staticClass:"d-flex flex-row justify-content-start align-items-start"},[r("b-button",{attrs:{size:"sm",variant:"info",disabled:e.loading},on:{click:e.getLogs}},[e.loading?r("font-awesome-icon",{attrs:{icon:"spinner",spin:""}}):r("font-awesome-icon",{attrs:{icon:"sync"}}),r("span",[e._v(" Reload")])],1),e.hasItems?r("b-button",{directives:[{name:"b-modal",rawName:"v-b-modal.modal-delete",modifiers:{"modal-delete":!0}}],staticClass:"ml-2",attrs:{size:"sm",variant:"danger",disabled:e.loading}},[r("font-awesome-icon",{attrs:{icon:"trash"}}),r("span",[e._v(" Delete logs")])],1):e._e(),r("b-modal",{attrs:{id:"modal-delete",title:"Delete logs"},on:{ok:e.handleOkDelete}},[r("p",{staticClass:"my-4"},[e._v("Are you sure you want to delete all logs for the current project?")])]),e.hasItems?r("b-pagination",{staticClass:"ml-2",attrs:{"total-rows":e.rows,"per-page":e.per_page,"aria-controls":"my-table",size:"sm"},model:{value:e.current_page,callback:function(t){e.current_page=t},expression:"current_page"}}):e._e()],1),r("b-table",{staticClass:"my-2",attrs:{id:"my-table",items:e.items_proxy,"_per-page":"per_page","_current-page":"current_page",small:"",bordered:"",striped:"",hover:""}}),e.hasItems?r("b-pagination",{attrs:{"total-rows":e.rows,"per-page":e.per_page,"aria-controls":"my-table",size:"sm"},model:{value:e.current_page,callback:function(t){e.current_page=t},expression:"current_page"}}):e._e()],1)},s=[],a=r(1258),o=r(4100),i=r(2697),c=(r(7941),r(5666),r(629)),u={data:function(){return{per_page:20,current_page:1,loading:!1}},created:function(){return(0,i.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},computed:(0,o.Z)((0,o.Z)({},(0,c.rn)({items:function(e){return e.logs.list}})),{},{items_proxy:function(){var e=(0,a.Z)(this.items),t=this.per_page,r=this.current_page*t-e.length;r<0&&(r=0);var n="",s={"no logs":n};if(e.length>0){s={};for(var o=e[0],i=0,c=Object.keys(o);i<c.length;i++){var u=c[i];s[u]=n}}for(var l=0;l<r;l++)e.push(s);return e},rows:function(){var e=this.$store.getters["logs/total"];return e||this.items.length},hasItems:function(){try{return this.items.length>0}catch(e){return!1}}}),watch:{current_page:{immediate:!0,handler:function(){this.getLogs()}}},methods:{getLogs:function(){var e=this;return(0,i.Z)(regeneratorRuntime.mark((function t(){var r,n,s,a,o,i,c,u,l;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,e.loading=!0,r=e.per_page,n=e.per_page*(e.current_page-1),t.next=6,e.$API.dispatch("logs/get",{start:n,limit:r});case 6:return s=t.sent,a=s.data,o=void 0===a?{}:a,i=o.data,c=void 0===i?{}:i,u=o.metadata,l=void 0===u?{}:u,t.next=11,e.$store.dispatch("logs/setState",{list:c,metadata:l});case 11:t.next=16;break;case 13:t.prev=13,t.t0=t["catch"](0),console.log(t.t0);case 16:return t.prev=16,e.loading=!1,t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[0,13,16,19]])})))()},handleOkDelete:function(){var e=this;return(0,i.Z)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$API.dispatch("logs/delete");case 2:r=t.sent,console.log(r),e.getLogs();case 5:case"end":return t.stop()}}),t)})))()}}},l=u,p=r(3736),d=(0,p.Z)(l,n,s,!1,null,"d102da56",null),m=d.exports},1886:function(e,t,r){r.r(t),r.d(t,{default:function(){return k}});var n=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",[r("h6",[e._v("Review your settings")]),r("table",{staticClass:"table table-bordered table-striped"},[e._m(0),r("tbody",e._l(e.settings,(function(t,n){return r("tr",{key:n},[r("td",[e._v(e._s(n))]),r("td",[r("pre",[e._v(e._s(t))])])])})),0)]),r("div",{staticClass:"buttons d-flex flex-row justify-content-between"},[e._t("left"),r("section",[r("button",{staticClass:"btn btn-primary ml-2",attrs:{disabled:e.processing},on:{click:e.importCSV}},[e.processing?r("font-awesome-icon",{attrs:{icon:"spinner",spin:"","fixed-width":""}}):r("font-awesome-icon",{attrs:{icon:"file-import","fixed-width":""}}),r("span",[e._v(" import")])],1)]),e._t("right",null,{validation:e.$v})],2),r("b-modal",{ref:"modal-success",attrs:{title:"Process completed","ok-only":"",size:"xl"},on:{hidden:e.onCloseModal}},[r("p",{staticClass:"my-4"},[e._v("The import proces is completed. Please check the "),r("router-link",{attrs:{to:{name:"logs"}}},[e._v("logs")]),e._v(" for details.")],1),r("LogsTable",{ref:"logs"})],1),r("b-modal",{ref:"modal-upload",attrs:{title:"Uploading CSV file","ok-only":"","no-close-on-esc":"","no-close-on-backdrop":"","hide-header-close":"","ok-title":"cancel"},on:{ok:e.onProcessStopped}},[r("FileUploader",{ref:"uploader",attrs:{files:e.files}})],1),r("b-modal",{ref:"modal-process",attrs:{id:"modal-process",title:"Processing CSV file","ok-only":"","no-close-on-esc":"","no-close-on-backdrop":"","hide-header-close":"","ok-title":"cancel",size:"xl"},on:{ok:e.onProcessStopped}},[r("FileProcesser",{ref:"processer",attrs:{background_process:e.background_process}}),r("LogsTable",{ref:"logs"})],1),r("b-modal",{ref:"modal-abort",attrs:{id:"modal-abort",title:"Process stopped","ok-only":""},on:{ok:e.onProcessStopped}},[r("p",{staticClass:"my-4"},[e._v("The process has been stopped by the user")])])],1)},s=[function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("thead",[r("tr",[r("th",[e._v("key")]),r("th",[e._v("value")])])])}],a=r(7742),o=r(2697),i=r(4100),c=(r(5666),r(8309),r(1539),r(8674),r(629)),u=r(8336),l=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",[e.processing&&!e.background_process?r("div",[r("b-progress",{attrs:{max:e.max,"show-progress":"",animated:"",variant:"success",height:"2rem"}},[r("b-progress-bar",{attrs:{value:e.progress,label:(100*e.progress).toFixed(2)+"%"}})],1),r("div",{staticClass:"text-muted small my-2"},[e.total_lines&&e.total_lines>0?r("span",[e._v("Processed "+e._s(e.current_line)+"/"+e._s(e.total_lines))]):e._e(),r("non-blank-space")],1)],1):e._e(),e._e()])},p=[],d={data:function(){return{cancel:null,max:1,current_line:0,processing:!1,abort:!1,progress:0}},computed:(0,i.Z)({},(0,c.rn)({settings:function(e){return e.import_settings},total_lines:function(e){return e.csv_data.total_lines}})),props:{background_process:{type:Boolean,default:!1}},destroyed:function(){this.reset()},methods:{process:function(e){var t=arguments,r=this;return(0,o.Z)(regeneratorRuntime.mark((function n(){var s,a;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(s=t.length>1&&void 0!==t[1]?t[1]:1,!r.abort){n.next=3;break}return n.abrupt("return");case 3:return r.processing=!0,n.prev=4,a=function(){var t=(0,o.Z)(regeneratorRuntime.mark((function t(n){var s,o,c,u,l,p,d;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return s=(0,i.Z)({},r.settings),s.background_process=r.background_process,s.data_row_start=n,o=r.$API.dispatch("importData/processCSV",e,s),r.cancel=o.cancel,t.next=7,o;case 7:if(c=t.sent,u=c.data,!u){t.next=16;break}if(!r.background_process){t.next=12;break}return t.abrupt("return",!0);case 12:return l=u.line,p=void 0===l?1:l,d=r.updateProgress({line:p}),r.$emit("progress",{progress:d}),t.abrupt("return",a(p));case 16:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n.next=8,a(s);case 8:r.$emit("completed"),n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](4),r.$emit("error",n.t0);case 14:return n.prev=14,r.processing=!1,n.finish(14);case 17:case"end":return n.stop()}}),n,null,[[4,11,14,17]])})))()},updateProgress:function(e){var t=e.line;if(!(this.total_lines<=0)&&(t&&(this.current_line=t),!isNaN(this.current_line)&&!isNaN(this.total_lines))){this.current_line>this.total_lines&&(this.current_line=this.total_lines);var r=this.current_line/this.total_lines;return this.progress=r,r}},reset:function(){"function"===typeof this.cancel&&this.cancel(),this.abort=!0}}},m=d,f=r(3736),h=(0,f.Z)(m,l,p,!1,null,null,null),g=h.exports,_=r(6775),v={components:{FileUploader:u.Z,FileProcesser:g,LogsTable:_.Z},data:function(){return{processing:!1,background_process:!1}},computed:(0,i.Z)((0,i.Z)({},(0,c.rn)({files:function(e){return e.import_settings.files},event_id:function(e){return e.import_settings.event_id},form_name:function(e){return e.import_settings.form_name},import_settings:function(e){return e.import_settings}})),{},{dynamic_fields:function(){return this.$store.getters["import_settings/mappedDynamicFields"]},mappedFieldsWithCsvNames:function(){return this.$store.getters["import_settings/mappedFieldsWithCsvNames"]},settings:function(){var e=this.files||{},t=e.name,r=void 0===t?"":t,n=(0,i.Z)({},this.import_settings),s={"file name":r,"event ID":n.event_id,"form name":n.form_name,"field delimiter":n.field_delimiter,"text qualifier":n.text_qualifier,"dates format":n.dates_format,"import mode":n.import_mode,"primary key":n.primary_key,"dynamic fields":this.dynamic_fields,mapping:this.mappedFieldsWithCsvNames};return s}}),methods:{showModal:function(e){var t=this,r=new Promise((function(r,n){var s=t.$refs[e];if(!s)return n();var a=function e(){s.$off("shown",e),r()};s.$on("shown",a),s.show()}));return r},closeModal:function(e){var t=this,r=new Promise((function(r,n){var s=t.$refs[e];if(!s)return n();var a=function e(){s.$off("hidden",e),r()};s.$on("hidden",a),s.hide()}));return r},upload:function(){var e=this;return(0,o.Z)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.showModal("modal-upload");case 2:return r=e.$refs.uploader,r.$on("completed",(function(){e.closeModal("modal-upload")})),r.$on("error",(function(e){var t=e.message,r=e.file,n=e.error;console.log({message:t,file:r,error:n})})),t.abrupt("return",r.upload());case 6:case"end":return t.stop()}}),t)})))()},updateLogs:function(){var e=this.$refs.logs.getLogs;"function"===typeof e&&e()},showCompleted:function(){var e=this;return(0,o.Z)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.showModal("modal-success");case 2:case"end":return t.stop()}}),t)})))()},enqueProcess:function(e){var t=this;return(0,o.Z)(regeneratorRuntime.mark((function r(){var n,s,o,c,u,l,p,d;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,n=(0,i.Z)({},t.import_settings),n.dynamic_fields=t.dynamic_fields,r.next=5,t.$API.dispatch("importData/enqueue",e,n);case 5:return s=r.sent,o=s.data,c="Import process created (ID ".concat(o["job_id"],"). Please check your logs."),r.next=10,t.$bvModal.msgBoxOk(c,{title:"Success",buttonSize:"sm"});case 10:t.$router.push({name:"home"}),r.next=18;break;case 13:r.prev=13,r.t0=r["catch"](0),u=r.t0,"object"===(0,a.Z)(r.t0)&&(l=r.t0.response.data,p=l.message,d=void 0===p?"error":p,u="".concat(d)),t.$bvModal.msgBoxOk(u,{title:"Error",buttonSize:"sm"});case 18:case"end":return r.stop()}}),r,null,[[0,13]])})))()},onProcessStopped:function(){var e=this;return(0,o.Z)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.showModal("modal-abort");case 2:case"end":return t.stop()}}),t)})))()},importCSV:function(){var e=this;return(0,o.Z)(regeneratorRuntime.mark((function t(){var r,n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.upload();case 3:if(r=t.sent,n=r.unique_name,n){t.next=7;break}return t.abrupt("return");case 7:return t.next=9,e.enqueProcess(n);case 9:t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](0),console.log(t.t0);case 14:return t.prev=14,e.processing=!1,e.background_process=!1,t.finish(14);case 18:case"end":return t.stop()}}),t,null,[[0,11,14,18]])})))()},onCloseModal:function(){console.log("done")}},validations:function(){return{}}},b=v,w=(0,f.Z)(b,n,s,!1,null,"fcebd24e",null),k=w.exports}}]);
//# sourceMappingURL=advanced_import.umd.min.886.js.map